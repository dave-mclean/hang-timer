<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1d4ed8">
    <meta name="description" content="Hang Timer - Interval training timer for hangboard workouts">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="/icons/hang.png">
    <link rel="stylesheet" href="style.css">
    <title>Max Hangs</title>
</head>
<body>
    <div class="container">
        <!-- Dynamic Title -->
        <h1 id="workout-title" style="font-size: 1.875rem; font-weight: bold; margin-bottom: 1rem; color: var(--color-text-main);">Max Hang</h1>


        <!-- Settings Dropdown -->
        <div class="settings-dropdown">
            <button class="settings-toggle" id="settings-toggle">
                Settings
            </button>
            <div class="settings-content" id="settings-content">
                <div id="settings" style="display: flex; gap: 2rem; justify-content: center; align-items: flex-end; margin-bottom: 1rem;">
                    <div style="display: flex; flex-direction: column; align-items: center;">
                        <label for="reps" class="picker-label">Reps</label>
                        <input type="number" id="reps" value="6" min="1" class="picker">
                    </div>
                </div>
                <div id="settings-row-2" style="display: flex; gap: 2rem; justify-content: center; align-items: flex-end; margin-bottom: 1rem;">
                    <div style="display: flex; flex-direction: column; align-items: center;">
                        <label for="rep-work" class="picker-label">Rep Work</label>
                        <input type="number" id="rep-work" value="6" min="1" class="picker">
                    </div>
                    <div style="display: flex; flex-direction: column; align-items: center;">
                        <label for="rep-rest" class="picker-label">Rep Rest</label>
                        <input type="number" id="rep-rest" value="4" min="1" class="picker">
                    </div>
                </div>
            </div>
        </div>

        <!-- Phase Indicator (WORK/REST/BREAK) -->
        <div id="phase-indicator" class="phase-indicator bg-ready" display>
            Ready
        </div>

        <!-- Overall Progress -->
        <p id="rep-count" style="font-size: 1.5rem; font-weight: 600; color: #6b7280; margin-bottom: 1.5rem;"></p>

        <!-- Timer Display -->
        <div id="timer-display" class="timer-display">
            00:00
        </div>

        <!-- Start Button -->
        <button id="start-button" class="btn-base btn-start">
            Start Workout
        </button>

        <!-- Stop Button -->
        <button id="stop-button" class="btn-base btn-stop" hidden="True">
            Stop Workout
        </button>

        <!-- Log Workout Button -->
        <button id="log-workout-button" class="btn-base btn-log" hidden="True">
            Log Workout
        </button>


    </div>

    <script type="text/javascript" src="hang.js"></script>
    <script>
        // --- DOM Elements ---
        const settingsToggle = document.getElementById('settings-toggle')
        const settingsContent = document.getElementById('settings-content')
        const repsUI = document.getElementById('reps')
        const repWorkUI = document.getElementById('rep-work')
        const repRestUI = document.getElementById('rep-rest')

        const timerDisplay = document.getElementById('timer-display')
        const startButton = document.getElementById('start-button')
        const stopButton = document.getElementById('stop-button')
        const logWorkoutButton = document.getElementById('log-workout-button')
        const phaseIndicator = document.getElementById('phase-indicator')
        const repCountDisplay = document.getElementById('rep-count')

        // Functions to get values from number pickers
        function get_reps() {return parseInt(repsUI.value)}
        function get_work_per_rep() {return parseInt(repWorkUI.value)}
        function get_rest_per_rep() {return parseInt(repRestUI.value)}
        function get_prepare_seconds() {return 10}


        // --- State Variables ---
        let intervalId = null;

        let total_reps = get_reps()
        let rest_per_rep = get_rest_per_rep()
        let work_per_rep = get_work_per_rep()
        let prepare_seconds = get_prepare_seconds()

        let current_rep = 1

        let phase = "READY"
        let seconds = '--'

        function begin_workout() {
            disable_settings()
            hide_begin_button()
            show_stop_button()
            hide_settings()
            phase = "PREPARE"
            seconds = prepare_seconds
            intervalId = setInterval(countdown, 1000);
        }

        function end_workout() {
            enable_settings()
            show_begin_button()
            hide_stop_button()
            show_log_button()
            show_settings()
            clearInterval(intervalId)

            phase = "READY"
            current_block = 1
            current_set = 1
            current_rep = 1
            seconds = '--'

            update_ui()
        }

        function play_beep(seconds) {
            count_in = 5
            if (phase === "WORK" || phase === "REST") {
                count_in = 3
            }

            if (phase === "WORK" && seconds === work_per_rep) {
                go_beep()
            } else if (phase === "REST" && seconds === rest_per_rep) {
                stop_beep()
            } else if (seconds <= count_in) {
                ready_beep()
            }

        }

        function countdown_prepare() {
            if (seconds === 1) {
                phase = "WORK"
                seconds = work_per_rep
            } else {
                seconds --
            }
        }

        function countdown_work() {
            if (seconds === 1) {
                if (current_rep === total_reps) {
                    seconds = '--'
                    phase = 'COMPLETE'
                    clearInterval(intervalId)
                    hide_stop_button()
                    show_log_button()
                    update_ui()
                } else {
                    phase = 'REST'
                    seconds = rest_per_rep
                }
            } else {
                seconds --
            }
        }

        function countdown_rest() {
            if (seconds === 1) {
                phase = 'WORK'
                current_rep ++
                seconds = work_per_rep
            }
            else {
                seconds --
            }
        }

        function countdown() {
            update_ui()
            play_beep(seconds)
            if (phase === "PREPARE"){
                countdown_prepare()
            } else if (phase === "WORK"){
                countdown_work()
            } else if (phase === "REST"){
                countdown_rest()
            }
        }

        function enable_settings(){
            repsUI.disabled = false
            repWorkUI.disabled = false
            repRestUI.disabled = false

            repsUI.style.border = ""
            repWorkUI.style.border = ""
            repRestUI.style.border = ""
        }

        function disable_settings(){
            repsUI.disabled = true
            repWorkUI.disabled = true
            repRestUI.disabled = true

            repsUI.style.border = "2px solid var(--colour-disabled)"
            repWorkUI.style.border = "2px solid var(--colour-disabled)"
            repRestUI.style.border = "2px solid var(--colour-disabled)"
        }


        function show_begin_button() {
            startButton.style.display = "";
        }

        function hide_begin_button() {
            startButton.style.display = "none";
        }

        function show_stop_button() {
            stopButton.hidden = false;
        }

         function hide_stop_button() {
            stopButton.hidden = true;
        }

        function show_log_button() {
            logWorkoutButton.hidden = false;
        }

        function hide_log_button() {
            logWorkoutButton.hidden = true;
        }

        function show_settings() {
            settingsToggle.style.display = "";
            settingsContent.style.display = "";
        }

        function hide_settings() {
            settingsToggle.style.display = "none";
            settingsContent.style.display = "none";
        }

        function update_ui() {

            timerDisplay.textContent = formatTime(seconds);
            repCountDisplay.textContent = `Rep: ${current_rep} / ${total_reps}`;

            // Remove all dynamic color classes
            phaseIndicator.textContent = phase;
            phaseIndicator.className = `phase-indicator bg-${phase.toLowerCase()}`
            timerDisplay.className = `timer-display text-${phase.toLowerCase()}`
        }

        // Google Sheets logging
        // Replace this URL with your Google Apps Script web app URL
        const GOOGLE_SHEETS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzV8mjXSXJx25ZJu-6hvIjiwiwKArw-5HiUb1CiIq82I7HU9aJISJFcu1Ku1LNkdkY8mA/exec';

        async function log_workout() {
            const workoutData = {
                timestamp: new Date().toISOString(),
                date: new Date().toLocaleDateString(),
                time: new Date().toLocaleTimeString(),
                reps: total_reps,
                work_per_rep: work_per_rep,
                rest_per_rep: rest_per_rep,
            };

            try {
                logWorkoutButton.disabled = true;
                logWorkoutButton.textContent = 'Logging...';

                const response = await fetch(GOOGLE_SHEETS_WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(workoutData)
                });

                // Since we're using no-cors, we can't read the response
                // But the data should still be sent
                logWorkoutButton.textContent = 'Logged! âœ“';
                logWorkoutButton.style.backgroundColor = '#10b981';

                setTimeout(() => {
                    logWorkoutButton.disabled = false;
                    logWorkoutButton.textContent = 'Log Workout';
                    logWorkoutButton.style.backgroundColor = '';
                }, 2000);

            } catch (error) {
                console.error('Error logging workout:', error);
                logWorkoutButton.textContent = 'Error - Try Again';
                logWorkoutButton.style.backgroundColor = '#dc2626';
                logWorkoutButton.disabled = false;

                setTimeout(() => {
                    logWorkoutButton.textContent = 'Log Workout';
                    logWorkoutButton.style.backgroundColor = '';
                }, 2000);
            }
        }

        // Initialize the display and add event listeners
        // Settings dropdown toggle
        function updateSettings() {
            total_reps = get_reps()
            work_per_rep = get_work_per_rep()
            rest_per_rep = get_rest_per_rep()
            prepare_seconds = get_prepare_seconds()

            update_ui()
        }

        document.addEventListener('DOMContentLoaded', () => {
            startButton.addEventListener('click', begin_workout);
            stopButton.addEventListener('click', end_workout);
            logWorkoutButton.addEventListener('click', log_workout);
            settingsToggle.addEventListener('click', toggleSettings);

            repsUI.addEventListener('change', updateSettings);
            repWorkUI.addEventListener('change', updateSettings);
            repRestUI.addEventListener('change', updateSettings);
        });

        update_ui();

        // Service Worker Registration for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registered successfully:', registration.scope);
                    })
                    .catch(error => {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }

    </script>

</body>
</html>